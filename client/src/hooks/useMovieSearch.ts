import { useState, useEffect } from 'react';
import { useQuery } from 'react-query';
import { api } from '../services/api';
import { logger } from '../utils/logger';

/**
 * üé£ REACT HOOK –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∏–ª—å–º–æ–≤
 * 
 * ‚ùì –ó–ê–ß–ï–ú –ù–£–ñ–ï–ù –•–£–ö (–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤ utils)?
 * 1. –£–ø—Ä–∞–≤–ª—è–µ—Ç –°–û–°–¢–û–Ø–ù–ò–ï–ú (—á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç)
 * 2. –î–µ–ª–∞–µ—Ç DEBOUNCING (–Ω–µ —Å–ø–∞–º–∏—Ç API –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É)
 * 3. –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
 * 4. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
 * 
 * üîÑ –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç "spider" ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É
 * ‚Üí —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏ ‚Üí –¥–µ–ª–∞–µ—Ç—Å—è API –∑–∞–ø—Ä–æ—Å
 * ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É
 * 
 * @param initialQuery - –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
 * @returns –û–±—ä–µ–∫—Ç —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–∏—Å–∫–∞ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
 */
export const useMovieSearch = (initialQuery: string = '') => {
  // üìù –°–û–°–¢–û–Ø–ù–ò–ï 1: –ß—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
  // –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É, —Å–≤—è–∑–∞–Ω–æ —Å input –ø–æ–ª–µ–º
  const [searchQuery, setSearchQuery] = useState(initialQuery);
  
  // üìù –°–û–°–¢–û–Ø–ù–ò–ï 2: –ó–∞–¥–µ—Ä–∂–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  // –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏
  // –ò–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–æ–º—É –∑–∞–ø—Ä–æ—Å—É –¥–µ–ª–∞–µ—Ç—Å—è API –≤—ã–∑–æ–≤
  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState(initialQuery);

  // ‚è±Ô∏è DEBOUNCING –≠–§–§–ï–ö–¢
  // –ó–∞—á–µ–º? –ß—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å API –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É!
  // –ü—Ä–∏–º–µ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç "spider man"
  // –ë–µ–∑ debouncing: 10 API –∑–∞–ø—Ä–æ—Å–æ–≤ (s, sp, spi, spid, ...)
  // –° debouncing: 1 API –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ "spider man"
  useEffect(() => {
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 500ms
    const timer = setTimeout(() => {
      // –ß–µ—Ä–µ–∑ 500ms –æ–±–Ω–æ–≤–ª—è–µ–º debouncedSearchQuery
      setDebouncedSearchQuery(searchQuery);
    }, 500);

    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –Ω–æ–≤–æ–º –≤–≤–æ–¥–µ
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å, —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
    return () => clearTimeout(timer);
  }, [searchQuery]); // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ searchQuery

  // üåê API –ó–ê–ü–†–û–° —Å –ø–æ–º–æ—â—å—é React Query
  // React Query - —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
  // –û–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç loading —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const { 
    data: searchResults,        // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –æ—Ç API
    isLoading: searching,       // true –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
    error: searchError          // –û—à–∏–±–∫–∞ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
  } = useQuery(
    // üîë –ö–õ–Æ–ß –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø: ['search-movies', 'spider man']
    // React Query –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —ç—Ç–æ–º—É –∫–ª—é—á—É
    // –ï—Å–ª–∏ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è - –≤–µ—Ä–Ω–µ—Ç –∏–∑ –∫—ç—à–∞
    ['search-movies', debouncedSearchQuery],
    
    // üì° –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–†–û–°–ê: –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω—ã –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    () => {
      logger.searchStarted(debouncedSearchQuery);
      return api.get('/movies/search', { 
        params: { query: debouncedSearchQuery } 
      }).then(res => {
        logger.searchResults(res.data.results.length);
        return res.data.results; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ —Ñ–∏–ª—å–º–æ–≤
      });
    },
    
    // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ó–ê–ü–†–û–°–ê
    {
      // –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤
      enabled: debouncedSearchQuery.length > 2,
      
      // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ 5 –º–∏–Ω—É—Ç
      // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ "spider" –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –≤–µ—Ä–Ω–µ—Ç –∫—ç—à
      staleTime: 5 * 60 * 1000,
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
      onError: (error) => {
        logger.error('Search query failed', error);
      }
    }
  );

  // üì§ –í–û–ó–í–†–ê–©–ê–ï–ú –û–ë–™–ï–ö–¢ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º
  return {
    // üìä –°–û–°–¢–û–Ø–ù–ò–ï
    searchQuery,                              // –¢–µ–∫—É—â–∏–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    searchResults: searchResults || [],       // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (–º–∞—Å—Å–∏–≤ —Ñ–∏–ª—å–º–æ–≤)
    searching,                                // –ò–¥–µ—Ç –ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞
    searchError,                              // –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    
    // üéõÔ∏è –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
    setSearchQuery,                           // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    clearSearch: () => setSearchQuery(''),    // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫
    
    // üßÆ –í–´–ß–ò–°–õ–Ø–ï–ú–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö)
    hasResults: searchResults && searchResults.length > 0,  // –ï—Å—Ç—å –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    showResults: searchQuery.length > 2,                    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  };
};
